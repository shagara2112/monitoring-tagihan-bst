generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  name      String?
  password  String
  role      UserRole  @default(STAFF)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  invoices  Invoice[]
}

model Invoice {
  id                String          @id @default(cuid())
  invoiceNumber     String          @unique
  clientName        String
  issueDate         DateTime
  dueDate           DateTime
  totalAmount       Float
  currency          String          @default("IDR")
  description       String
  status            InvoiceStatus   @default(DRAFT)
  position          InvoicePosition @default(MITRA)
  workRegion        WorkRegion      @default(TARAKAN)
  jobTitle        String?
  workPeriod      String?
  category        InvoiceCategory?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  settlementDate    DateTime?
  settlementAmount  Float?
  paymentMethod     String?
  settlementNotes   String?
  positionUpdatedAt DateTime?
  positionUpdatedBy String?
  createdById       String
  createdBy         User            @relation(fields: [createdById], references: [id])
  histories         InvoiceHistory[]

  @@index([status])
  @@index([position])
  @@index([workRegion])
  @@index([clientName])
  @@index([dueDate])
  @@index([issueDate])
}

model InvoiceHistory {
  id        String   @id @default(cuid())
  invoiceId String
  field     String   // 'status' or 'position'
  oldValue  String?
  newValue  String
  changedBy String
  changedAt DateTime @default(now())
  notes     String?

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@index([field])
  @@index([changedAt])
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  STAFF
  MANAGER
}

enum InvoiceStatus {
  DRAFT
  SUBMITTED
  INTERNAL_VALIDATION
  AWAITING_PAYMENT
  SETTLED
  DELAYED
}

enum InvoicePosition {
  MITRA
  USER
  AREA
  REGIONAL
  HEAD_OFFICE
  APM
  TERBAYAR
}

enum WorkRegion {
  TARAKAN
  BALIKPAPAN
  SAMARINDA
}

enum InvoiceCategory {
  PASANG_BARU
  ASSURANCE
  MAINTENANCE
  OSP
  SIPIL
  KONSTRUKSI
  LAINNYA
}
